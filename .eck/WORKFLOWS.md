# Рабочие процессы ECKWMS

## Общий Workflow: Архитектор → Кодер

```
1. Пользователь → Запрос на изменение
2. Архитектор → Анализ и планирование
3. Архитектор → Создание технического задания
4. Архитектор → ЖДЁТ подтверждения пользователя
5. Пользователь → Подтверждение плана
6. Архитектор → Генерация команд для Кодера
7. Кодер → Реализация
8. Кодер → Тестирование
9. Кодер → Деплой
10. Кодер → Проверка работоспособности
```

---

## Процесс 1: Добавление новой фичи

### Фаза планирования (Архитектор)

**Шаги:**
1. Получить requirements от пользователя
2. Проанализировать текущую архитектуру
3. Спроектировать изменения:
   - API эндпоинты
   - Модели данных
   - Схема БД (если нужно)
4. Создать пошаговый план реализации
5. СТОП - дождаться одобрения пользователя
6. После одобрения: сформировать команды для Кодера

### Фаза реализации (Кодер)

**Шаги:**
1. Создать/изменить файлы согласно плану
2. Написать миграцию БД (если нужно)
3. Обновить документацию
4. Протестировать локально
5. Закоммитить изменения
6. Отправить на GitHub
7. Развернуть на продакшене
8. Проверить логи
9. Убедиться что сервис работает

---

## Процесс 2: Миграция базы данных

### Планирование (Архитектор)

**Определить:**
- Какие таблицы затронуты
- Какие колонки добавить/изменить/удалить
- Индексы и ограничения
- Влияние на существующие данные
- Необходимость бэкапа

**Создать план:**
```
1. Создать скрипт миграции
2. Протестировать на копии БД
3. Сделать бэкап production БД
4. Применить миграцию
5. Проверить целостность данных
6. Перезапустить сервис
```

### Реализация (Кодер)

**Действия:**
1. Создать скрипт миграции в `services/eckwms-global/scripts/`
2. Использовать правильный шаблон подключения к БД
3. Протестировать локально
4. Закоммитить скрипт
5. Отправить на GitHub
6. На продакшене:
   - Сделать бэкап БД
   - Получить изменения с GitHub
   - Запустить скрипт миграции
   - Проверить логи
   - Перезапустить сервис
   - Проверить что всё работает

---

## Процесс 3: Обновление кода на продакшене

### Подготовка (Кодер)

**Локально:**
1. Убедиться что все изменения работают
2. Запустить тесты (если есть)
3. Закоммитить изменения с понятным сообщением
4. Отправить на GitHub

### Деплой (Кодер)

**На сервере:**
1. Получить изменения с GitHub
2. Установить новые зависимости (если есть)
3. Перезапустить сервис
4. Проверить логи на ошибки
5. Проверить health check
6. Убедиться что всё работает корректно

---

## Процесс 4: Отладка проблемы на продакшене

### Диагностика (Кодер)

**Шаги:**
1. Проверить статус сервиса
2. Просмотреть логи ошибок
3. Проверить подключение к БД
4. Проверить доступность API
5. Идентифицировать источник проблемы

### Исправление (Кодер)

**Действия:**
1. Если нужно изменение кода:
   - Исправить локально
   - Протестировать
   - Закоммитить и отправить
   - Развернуть на продакшен
2. Если проблема с конфигурацией:
   - Обновить конфигурацию
   - Перезапустить сервис
3. Если проблема с БД:
   - Исправить данные (осторожно!)
   - Перезапустить сервис

### Эскалация (Архитектор)

**Когда передавать Архитектору:**
- Проблема требует изменения архитектуры
- Неясно как исправить
- Проблема повторяется систематически
- Нужно принять решение о подходе

---

## Процесс 5: Добавление нового API эндпоинта

### Дизайн (Архитектор)

**Определить:**
- URL и HTTP метод
- Входные параметры
- Формат ответа
- Обработка ошибок
- Аутентификация
- Валидация

**Пример спецификации:**
```
POST /ECK/API/DEVICE/UPDATE
Headers: X-API-Key: <key>
Body: {
  device_uuid: string,
  status: 'active' | 'blocked'
}
Response: {
  success: boolean,
  message: string
}
```

### Имплементация (Кодер)

**Действия:**
1. Создать route handler
2. Добавить валидацию
3. Реализовать бизнес-логику
4. Добавить обработку ошибок
5. Протестировать локально
6. Обновить документацию API
7. Развернуть на продакшен

---

## Процесс 6: Рефакторинг кода

### Планирование (Архитектор)

**Определить:**
- Что рефакторить и почему
- Как улучшится архитектура
- Риски изменений
- План поэтапного рефакторинга

### Реализация (Кодер)

**Принципы:**
1. Делать маленькие изменения
2. Тестировать после каждого шага
3. Коммитить часто
4. Сохранять обратную совместимость
5. Не смешивать рефакторинг с новыми фичами

---

## Процесс 7: Обработка критического бага на продакшене

### Немедленные действия (Кодер)

**Hotfix workflow:**
1. Идентифицировать проблему
2. Создать минимальное исправление
3. Протестировать быстро
4. Развернуть немедленно
5. Проверить что проблема решена
6. Закоммитить hotfix

### Пост-мортем (Архитектор + Кодер)

**Анализ:**
- Почему произошла проблема
- Как можно было предотвратить
- Какие изменения нужны в процессе
- Обновить документацию

---

## Делегирование задач

### Когда использовать Архитектора

✅ **Архитектор нужен для:**
- Планирования новых фич
- Изменения структуры БД
- Принятия архитектурных решений
- Проектирования API
- Решения сложных технических вопросов
- Анализа performance проблем

❌ **Архитектор НЕ нужен для:**
- Простых багфиксов
- Рутинных обновлений
- Деплоя готового кода
- Рестарта сервисов
- Просмотра логов

### Когда использовать Кодера

✅ **Кодер нужен для:**
- Написания кода
- Миграций БД
- Деплоя на продакшен
- Отладки
- Работы с логами
- Управления сервисами
- Багфиксов

❌ **Кодер НЕ должен:**
- Принимать архитектурные решения
- Менять структуру БД без плана
- Добавлять фичи без согласования
- Изменять API контракты самостоятельно

---

## Коммуникация между ролями

### Формат задачи для Кодера

**От Архитектора к Кодеру:**
```json
{
  "target_agent": "production_server",
  "task_id": "unique-task-id",
  "objective": "Краткое описание цели",
  "steps": [
    "Конкретный шаг 1",
    "Конкретный шаг 2",
    ...
  ],
  "validation": [
    "Как проверить результат"
  ]
}
```

### Обратная связь

**От Кодера к пользователю/Архитектору:**
- Статус выполнения
- Обнаруженные проблемы
- Результаты валидации
- Логи (если нужно)

---

## Best Practices

### Для безопасности
- Всегда делать бэкапы перед миграциями
- Тестировать на копии данных
- Иметь план отката

### Для надёжности
- Проверять логи после каждого деплоя
- Мониторить health check
- Иметь документацию всех процессов

### Для эффективности
- Автоматизировать рутинные задачи
- Использовать CI/CD где возможно
- Документировать новые процессы

---

См. также:
- [ARCHITECTURE.md](ARCHITECTURE.md) - Архитектура системы
- [OPERATIONS.md](OPERATIONS.md) - Операции и команды
- [QUICK_REFERENCE.md](../QUICK_REFERENCE.md) - Быстрая справка для кодера

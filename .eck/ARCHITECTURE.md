# Архитектура системы ECKWMS

## Общая структура проекта

```
eckwms/
├── services/
│   └── eckwms-global/          # Глобальный микросервис
│       ├── src/
│       │   └── server.js       # Точка входа (Express API)
│       ├── scripts/            # Утилиты и миграции
│       └── .env                # Конфигурация микросервиса
├── src/
│   ├── server/                 # Основной API (legacy/shared)
│   ├── shared/                 # Общий код
│   └── models/                 # Модели данных
├── migrations/                 # Миграции БД
└── QUICK_REFERENCE.md          # Быстрая справка для разработчиков
```

---

## Микросервисы

### eckwms-global

**Назначение:** Глобальный сервис для регистрации и управления устройствами

**Технические характеристики:**
- **База данных:** PostgreSQL (база: `eckwms_global`)
- **Порт:** 8080
- **Управление:** PM2 (имя процесса: `eckwms-global`)
- **Протокол:** HTTP/REST API

**Основные эндпоинты:**
- `POST /ECK/API/DEVICE/REGISTER` - Регистрация нового устройства
- `GET /ECK/HEALTH` - Health check сервиса
- `POST /ECK/PROXY` - Прокси для запросов к инстансам

**Модель данных:**
```
registered_devices:
  - device_uuid (UUID, PRIMARY KEY)
  - instance_id (VARCHAR)
  - public_url (VARCHAR)
  - last_seen (TIMESTAMP)
  - status (VARCHAR: 'active', 'pending', 'blocked')
```

---

## Типы окружений

### Development (Локальная разработка)

**Характеристики:**
- **Расположение:** Локальная машина разработчика
- **База данных:** SQLite (файловая)
- **Запуск:** `npm run dev`
- **GUI:** Доступен (Electron)
- **Особенности:**
  - Быстрая итерация
  - Отладка с breakpoints
  - Тестирование UI

**Когда использовать:**
- Разработка новых фич
- Локальное тестирование
- Отладка интерфейса

---

### Production (Продакшн сервер)

**Характеристики:**
- **Платформа:** Linux (Ubuntu)
- **База данных:** PostgreSQL
- **Управление:** PM2
- **Веб-сервер:** Nginx (reverse proxy)
- **Режим:** Headless (без GUI)

**Особенности:**
- Автоматический рестарт (PM2)
- Логирование
- Масштабируемость
- Надёжность

**Когда использовать:**
- Деплой готовых фич
- Production-ready код
- Реальные пользователи

---

## Архитектурные паттерны

### Микросервисная архитектура

**Преимущества:**
- Независимое масштабирование
- Изоляция сбоев
- Технологическая независимость

**Коммуникация между сервисами:**
- HTTP REST API
- JSON формат данных
- Прокси-паттерн для роутинга

---

### База данных

**Development:**
- SQLite - простота, портативность
- Файловое хранение
- Подходит для тестирования

**Production:**
- PostgreSQL - надёжность, производительность
- ACID транзакции
- Поддержка сложных запросов
- Репликация и бэкапы

---

## Разделение ответственности

### Роль Архитектора

**Задачи:**
- Планирование новых фич
- Принятие архитектурных решений
- Проектирование схемы БД
- Определение API контрактов
- Создание технических заданий для Кодера

**Не занимается:**
- Написанием кода
- Деплоем на сервер
- Отладкой production
- Конфигурацией инфраструктуры

---

### Роль Кодера

**Задачи:**
- Реализация фич по ТЗ
- Написание миграций БД
- Деплой на production
- Отладка и troubleshooting
- Работа с логами
- Управление сервисами (PM2)

**Не занимается:**
- Принятием архитектурных решений
- Планированием фич
- Изменением архитектуры без согласования

---

## Потоки данных

### Регистрация устройства

```
Устройство → POST /ECK/API/DEVICE/REGISTER
           → eckwms-global:8080
           → Проверка данных
           → Запись в PostgreSQL (registered_devices)
           → Ответ: success/error
```

### Прокси запрос

```
Клиент → POST /ECK/PROXY (с заголовком X-eckWMS-Target-Url)
       → eckwms-global:8080
       → Поиск registered_devices по instance_id
       → Проксирование запроса на public_url устройства
       → Возврат ответа клиенту
```

---

## Масштабирование

### Горизонтальное масштабирование

**eckwms-global:**
- Возможность запуска нескольких инстансов
- Load balancing через Nginx
- Shared PostgreSQL database

### Вертикальное масштабирование

**База данных:**
- Увеличение ресурсов PostgreSQL
- Индексирование
- Оптимизация запросов

---

## Безопасность

### Аутентификация
- API ключи (GLOBAL_SERVER_API_KEY)
- Проверка на каждом запросе

### Валидация данных
- Проверка входящих данных
- Санитизация
- Защита от SQL injection (Sequelize ORM)

### Сетевая безопасность
- HTTPS (Nginx)
- Firewall правила
- Rate limiting

---

## Мониторинг и логирование

### Логи приложения
- PM2 логирование
- Ротация логов
- Error tracking

### Метрики
- PM2 status (uptime, memory, CPU)
- Health check эндпоинт
- Database connection pool stats

---

## Дальнейшее развитие

См. [ROADMAP.md](ROADMAP.md) для планов развития проекта.

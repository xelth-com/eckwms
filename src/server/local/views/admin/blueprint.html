<!DOCTYPE html>
<html lang="en">

<head>
    <script src="/js/auth-client.js"></script>
    <script>
    // Client-side auth check with token refresh
    (async function() {
        const authClient = new AuthClient();
        if (!authClient.getAccessToken()) {
            authClient.redirectToLogin();
            return;
        }
        // Test token validity by making a simple request
        try {
            const testResponse = await authClient.fetch('/admin/api/warehouses');
            if (!testResponse.ok && testResponse.status === 401) {
                // Token refresh failed, redirect to login
                authClient.redirectToLogin();
            }
        } catch (err) {
            console.error('Auth check failed:', err);
            authClient.redirectToLogin();
        }
    })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Blueprint | eckWMS</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --text-main: #C0C0C0;
            --text-secondary: #888888;
            --accent-blue: #5a7ba9;
            --accent-hover: #4a6b99;
            --success: #0d9488;
            --warning: #b45309;
            --danger: #991b1b;
            --border: #2a2a2a;
            --grid-line: #1a1a1a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Dark mode scrollbars */
        * {
            scrollbar-width: thin;
            scrollbar-color: #3a3a3a #1a1a1a;
        }

        *::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #3a3a3a;
            border-radius: 6px;
            border: 2px solid #1a1a1a;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #4a4a4a;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .back-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            flex-grow: 1;
            overflow: hidden;
        }

        /* Sidebar / Controls */
        .sidebar {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .rack-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        input {
            width: 100%;
            padding: 10px;
            background: #111;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: #333;
            color: #ddd;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
            margin-top: 5px;
        }

        /* Blueprint Canvas */
        .canvas-area {
            background: var(--bg-color);
            border: 1px solid var(--border);
            border-radius: 12px;
            position: relative;
            overflow: auto;
            background-image:
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 50px 50px;
            cursor: crosshair;
        }

        .canvas-container {
            position: relative;
            min-width: 100%;
            min-height: 100%;
            width: max-content;
            height: max-content;
        }

        .rack-node {
            position: absolute;
            background: var(--accent-blue);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: move;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            padding: 5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s, box-shadow 0.2s;
            user-select: none;
            min-width: 60px;
            min-height: 40px;
        }

        .rack-node:hover {
            box-shadow: 0 0 15px var(--accent-blue);
            z-index: 100 !important;
        }

        .rack-node.selected {
            border-color: white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
            z-index: 101 !important;
        }

        .rack-node .info {
            font-size: 0.7rem;
            opacity: 0.8;
            font-weight: normal;
        }

        .racks-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rack-item {
            background: #252525;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rack-item:hover {
            border-color: var(--accent-blue);
        }

        .rack-item.active {
            border-color: var(--accent-blue);
            background: rgba(90, 123, 169, 0.1);
        }

        .rack-item .name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .rack-item .meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .success {
            background: var(--success);
            color: white;
        }

        .error {
            background: var(--danger);
            color: white;
        }
    </style>
</head>

<body>
    <div class="header">
        <a href="/admin" class="back-link">üè† Home</a>
        <h1>üìê Warehouse Blueprint</h1>
        <div style="width: 50px;"></div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <h2>Rack Management</h2>

            <!-- Warehouse Selector (hidden if only 1 warehouse) -->
            <div class="form-group" id="warehouseSelector" style="display: none;">
                <label>Warehouse</label>
                <select id="warehouseSelect" style="width: 100%; padding: 10px; background: #111; border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 0.9rem;">
                    <option value="">Loading...</option>
                </select>
            </div>

            <div class="rack-form" id="rackForm">
                <input type="hidden" id="editRackId">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="rackName" placeholder="e.g. Rack A">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Cols</label>
                        <input type="number" id="rackCols" placeholder="5">
                    </div>
                    <div class="form-group">
                        <label>Rows</label>
                        <input type="number" id="rackRows" placeholder="10">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Start ID</label>
                        <input type="number" id="rackStart" placeholder="Auto">
                    </div>
                    <div class="form-group">
                        <label>Rack ID</label>
                        <input type="number" id="rackSort" placeholder="Auto">
                    </div>
                </div>

                <!-- Visual Sizing Override -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                    <div class="form-group">
                        <label>Visual Width (px)</label>
                        <input type="number" id="rackVisualWidth" placeholder="Auto" value="0">
                    </div>
                    <div class="form-group">
                        <label>Visual Height (px)</label>
                        <input type="number" id="rackVisualHeight" placeholder="Auto" value="0">
                    </div>
                </div>

                <!-- Rotation Control -->
                <div class="form-group" style="margin-top: 5px;">
                    <label>Rotation</label>
                    <select id="rackRotation" style="width: 100%; padding: 10px; background: #111; border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 0.9rem;">
                        <option value="0">0¬∞ (Horizontal)</option>
                        <option value="90">90¬∞ (Vertical)</option>
                        <option value="180">180¬∞ (Inverted)</option>
                        <option value="270">270¬∞ (Vert. Inverted)</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                    <button class="btn btn-primary" onclick="saveRack()">Save Rack</button>
                    <button class="btn btn-secondary" onclick="resetForm()">Clear</button>
                </div>
                <button id="btnDelete" class="btn btn-delete" style="display:none;" onclick="deleteRack()">Delete
                    Rack</button>
            </div>

            <div class="racks-list" id="racksList">
                <!-- Rack items will be rendered here -->
            </div>
        </div>

        <div class="canvas-area" id="canvasArea">
            <div class="canvas-container" id="canvas">
                <!-- Racks nodes will be rendered here -->
            </div>
        </div>
    </div>

    <div id="alert" class="alert"></div>

    <script>
        let warehouses = [];
        let registeredRacks = [];
        let selectedRackId = null;
        let selectedWarehouseId = null;
        let isDragging = false;
        let dragTarget = null;
        let offset = { x: 0, y: 0 };

        const canvas = document.getElementById('canvas');
        const canvasArea = document.getElementById('canvasArea');
        const racksList = document.getElementById('racksList');
        const alertBox = document.getElementById('alert');
        const warehouseSelector = document.getElementById('warehouseSelector');
        const warehouseSelect = document.getElementById('warehouseSelect');

        // Load both warehouses and racks
        async function loadData() {
            await loadWarehouses();
            await loadRacks();
        }

        async function loadWarehouses() {
            try {
                const response = await authClient.fetch('/admin/api/warehouses');
                if (response.ok) {
                    warehouses = await response.json();

                    // Show/hide warehouse selector based on count
                    if (warehouses.length > 1) {
                        warehouseSelector.style.display = 'block';
                        warehouseSelect.innerHTML = warehouses.map(wh =>
                            `<option value="${wh.id}">${wh.name} (ID Offset: ${wh.id_offset})</option>`
                        ).join('');

                        // Set default to first warehouse
                        if (!selectedWarehouseId && warehouses.length > 0) {
                            selectedWarehouseId = warehouses[0].id;
                            warehouseSelect.value = selectedWarehouseId;
                        }
                    } else if (warehouses.length === 1) {
                        // Single warehouse mode - hide selector, auto-select
                        warehouseSelector.style.display = 'none';
                        selectedWarehouseId = warehouses[0].id;
                    }
                }
            } catch (e) {
                console.error('Error loading warehouses:', e);
                showAlert('Failed to load warehouses', 'error');
            }
        }

        async function loadRacks() {
            try {
                let url = '/admin/api/warehouse/racks';
                if (selectedWarehouseId) {
                    url += `?warehouse_id=${selectedWarehouseId}`;
                }

                const response = await authClient.fetch(url);
                if (response.ok) {
                    registeredRacks = await response.json();
                    renderRacks();
                    renderList();
                }
            } catch (e) {
                console.error(e);
                showAlert('Failed to load racks', 'error');
            }
        }

        // Handle warehouse selection change
        warehouseSelect.addEventListener('change', async (e) => {
            selectedWarehouseId = parseInt(e.target.value);
            resetForm();
            await loadRacks();
        });

        function renderRacks() {
            // Only remove nodes, keep controls
            const nodes = canvas.querySelectorAll('.rack-node');
            nodes.forEach(n => n.remove());

            registeredRacks.forEach(rack => {
                const node = document.createElement('div');
                node.className = `rack-node ${selectedRackId == rack.id ? 'selected' : ''}`;
                node.id = `node-${rack.id}`;

                // 50px Grid Logic - 1 unit = 50px
                let w, h;
                if (rack.visual_width && rack.visual_width > 0) {
                    w = rack.visual_width;
                } else {
                    w = (parseInt(rack.columns) || 1) * 50;
                }

                if (rack.visual_height && rack.visual_height > 0) {
                    h = rack.visual_height;
                } else {
                    h = (parseInt(rack.rows) || 1) * 50;
                }

                node.style.width = w + 'px';
                node.style.height = h + 'px';
                node.style.left = (rack.posX || 0) + 'px';
                node.style.top = (rack.posY || 0) + 'px';

                // Apply Rotation
                const rot = rack.rotation || 0;
                node.style.transform = `rotate(${rot}deg)`;
                node.style.transformOrigin = 'center';

                // Indicator dot (like on microchips) - shows rack start position
                const dot = document.createElement('div');
                dot.style.position = 'absolute';
                dot.style.width = '8px';
                dot.style.height = '8px';
                dot.style.borderRadius = '50%';
                dot.style.backgroundColor = 'white';
                dot.style.bottom = '4px';
                dot.style.left = '4px';
                dot.style.boxShadow = '0 0 3px rgba(0,0,0,0.5)';
                dot.style.zIndex = '10';
                node.appendChild(dot);

                // Text rotation using dot product rule - always readable orientation
                // Need to counter-rotate to achieve desired absolute angle
                // Horizontal racks (0¬∞, 180¬∞) ‚Üí text at 0¬∞ on screen
                // Vertical racks (90¬∞, 270¬∞) ‚Üí text at 90¬∞ on screen
                let desiredTextAngle;
                if (rot === 90 || rot === 270) {
                    desiredTextAngle = 90; // Want vertical text on screen
                } else {
                    desiredTextAngle = 0; // Want horizontal text on screen
                }
                // Counter-rotate: textRot = desired angle - rack angle
                let textRot = desiredTextAngle - rot;

                // Create content using DOM methods to avoid XSS
                // Show everything in one line: #ID dimensions name
                const labelDiv = document.createElement('div');
                labelDiv.style.fontWeight = 'bold';
                labelDiv.style.fontSize = '0.85rem';
                labelDiv.style.whiteSpace = 'nowrap';
                labelDiv.style.transform = `rotate(${textRot}deg)`;
                labelDiv.style.textShadow = '0 1px 2px rgba(0,0,0,0.8)';

                // 1. Rack ID (White & Bold)
                const idSpan = document.createElement('span');
                idSpan.style.color = '#ffffff';
                idSpan.style.fontWeight = '900';
                idSpan.style.marginRight = '6px';
                idSpan.textContent = `#${rack.sort_order || 0}`;
                labelDiv.appendChild(idSpan);

                // 2. Dimensions (Amber/Gold)
                const dimSpan = document.createElement('span');
                dimSpan.style.color = '#fbbf24';
                dimSpan.style.fontWeight = '600';
                dimSpan.style.marginRight = '6px';
                dimSpan.textContent = `${rack.columns}√ó${rack.rows}`;
                labelDiv.appendChild(dimSpan);

                // 3. Name (Lime Green)
                if (rack.name && rack.name.trim()) {
                    const nameSpan = document.createElement('span');
                    nameSpan.style.color = '#a3e635';
                    nameSpan.style.fontWeight = '500';
                    nameSpan.textContent = rack.name;
                    labelDiv.appendChild(nameSpan);
                }

                node.appendChild(labelDiv);

                node.addEventListener('mousedown', (e) => startDrag(e, rack));
                node.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectRack(rack.id);
                });

                canvas.appendChild(node);
            });
        }

        function renderList() {
            racksList.innerHTML = '';
            registeredRacks.forEach(rack => {
                const item = document.createElement('div');
                item.className = `rack-item ${selectedRackId == rack.id ? 'active' : ''}`;

                // Create content safely
                const contentDiv = document.createElement('div');

                // Top line: Rack ID
                const idDiv = document.createElement('div');
                idDiv.className = 'name';
                idDiv.textContent = `Rack #${rack.sort_order || 0}`;

                // Second line: Name (if exists)
                const nameDiv = document.createElement('div');
                nameDiv.className = 'meta';
                if (rack.name && rack.name.trim()) {
                    nameDiv.textContent = rack.name;
                } else {
                    nameDiv.textContent = `${rack.columns} cols, ${rack.rows} rows`;
                    nameDiv.style.opacity = '0.6';
                }

                contentDiv.appendChild(idDiv);
                contentDiv.appendChild(nameDiv);
                item.appendChild(contentDiv);

                item.onclick = () => selectRack(rack.id);
                racksList.appendChild(item);
            });
        }

        function selectRack(id) {
            selectedRackId = id;
            const rack = registeredRacks.find(r => r.id == id);
            if (rack) {
                document.getElementById('editRackId').value = rack.id;
                document.getElementById('rackName').value = rack.name;
                document.getElementById('rackCols').value = rack.columns;
                document.getElementById('rackRows').value = rack.rows;
                document.getElementById('rackStart').value = rack.start_index;
                document.getElementById('rackSort').value = rack.sort_order || 0;
                document.getElementById('rackVisualWidth').value = rack.visual_width || 0;
                document.getElementById('rackVisualHeight').value = rack.visual_height || 0;
                document.getElementById('rackRotation').value = rack.rotation || 0;
                document.getElementById('btnDelete').style.display = 'block';
            }
            renderRacks();
            renderList();
        }

        function resetForm() {
            selectedRackId = null;
            document.getElementById('editRackId').value = '';
            document.getElementById('rackName').value = '';
            document.getElementById('rackCols').value = '';
            document.getElementById('rackRows').value = '';
            document.getElementById('rackStart').value = '';
            document.getElementById('rackSort').value = 0;
            document.getElementById('rackVisualWidth').value = 0;
            document.getElementById('rackVisualHeight').value = 0;
            document.getElementById('rackRotation').value = 0;
            document.getElementById('btnDelete').style.display = 'none';
            renderRacks();
            renderList();
        }

        async function saveRack() {
            const idRaw = document.getElementById('editRackId').value;
            const startIndexRaw = document.getElementById('rackStart').value;

            const data = {
                id: idRaw ? parseInt(idRaw) : null,
                name: document.getElementById('rackName').value,
                columns: parseInt(document.getElementById('rackCols').value),
                rows: parseInt(document.getElementById('rackRows').value),
                // If empty, send -1 to trigger backend auto-calc
                start_index: startIndexRaw === '' ? -1 : parseInt(startIndexRaw),
                sort_order: parseInt(document.getElementById('rackSort').value) || 0,
                visual_width: parseInt(document.getElementById('rackVisualWidth').value) || 0,
                visual_height: parseInt(document.getElementById('rackVisualHeight').value) || 0,
                rotation: parseInt(document.getElementById('rackRotation').value) || 0,
                warehouse_id: selectedWarehouseId
            };

            // If updating existing, preserve coordinates
            const existing = registeredRacks.find(r => r.id == data.id);
            if (existing) {
                data.posX = existing.posX;
                data.posY = existing.posY;
            }

            if (!data.name || isNaN(data.columns) || isNaN(data.rows)) {
                showAlert('Please fill Name, Cols, and Rows', 'error');
                return;
            }

            try {
                const resp = await authClient.fetch('/admin/api/warehouse/racks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                if (resp.ok) {
                    const resData = await resp.json();
                    showAlert(`Rack saved! ${resData.calculatedStartId !== undefined ? 'Auto-assigned ID: ' + resData.calculatedStartId : ''}`, 'success');
                    if (!data.id) resetForm();
                    loadRacks();
                } else {
                    showAlert('Error saving rack', 'error');
                }
            } catch (e) { showAlert('Error saving rack', 'error'); }
        }

        async function deleteRack() {
            if (!selectedRackId || !confirm('Delete this rack and its position?')) return;
            try {
                const resp = await authClient.fetch(`/admin/api/warehouse/racks/${selectedRackId}`, {
                    method: 'DELETE'
                });
                if (resp.ok) {
                    resetForm();
                    await loadRacks();
                    showAlert('Rack deleted', 'success');
                }
            } catch (e) { showAlert('Error deleting rack', 'error'); }
        }

        function startDrag(e, rack) {
            isDragging = true;
            dragTarget = rack;
            selectRack(rack.id);

            const node = document.getElementById(`node-${rack.id}`);
            const rect = node.getBoundingClientRect();
            offset.x = e.clientX - rect.left;
            offset.y = e.clientY - rect.top;

            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function onDrag(e) {
            if (!isDragging || !dragTarget) return;

            const canvasRect = canvas.getBoundingClientRect();
            let x = e.clientX - canvasRect.left - offset.x;
            let y = e.clientY - canvasRect.top - offset.y;

            // Snapping to 10px grid
            x = Math.round(x / 10) * 10;
            y = Math.round(y / 10) * 10;

            // Constrain
            x = Math.max(0, Math.min(x, canvasRect.width - 60));
            y = Math.max(0, Math.min(y, canvasRect.height - 40));

            dragTarget.posX = x;
            dragTarget.posY = y;

            const node = document.getElementById(`node-${dragTarget.id}`);
            node.style.left = x + 'px';
            node.style.top = y + 'px';
        }

        async function stopDrag() {
            if (isDragging && dragTarget) {
                // Save coordinates
                try {
                    await authClient.fetch('/admin/api/warehouse/racks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dragTarget)
                    });
                } catch (e) { console.error('Auto-save position failed', e); }
            }

            isDragging = false;
            dragTarget = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        function showAlert(msg, type) {
            alertBox.textContent = msg;
            alertBox.className = `alert ${type}`;
            alertBox.style.display = 'block';
            setTimeout(() => { alertBox.style.display = 'none'; }, 3000);
        }

        canvas.addEventListener('click', (e) => {
            if (e.target === canvas) resetForm();
        });

        // Initialize: Load warehouses and racks
        loadData();
    </script>
</body>

</html>